<!DOCTYPE html>
<html>
<head>
    <title>Hyper Roll</title>
    <link href="/webjars/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <script src="/webjars/jquery/jquery.min.js"></script>
    <script src="/webjars/sockjs-client/sockjs.min.js"></script>
    <script src="/webjars/stomp-websocket/stomp.min.js"></script>
    <script src="/app.js"></script>
</head>
	<body>
		<noscript>
			<h2 style="color: #ff0000">Seems your browser doesn't support Javascript! Websocket relies on Javascript being
				enabled. Please enable Javascript and reload this page!
			</h2>
		</noscript>
		<div id="app-container" style="padding-left: 10px;">
			<h3> AWS Hyper Roll MVP</h3>
			<div id="home-menu" style="display: block ;">
				<button id="bot-game-btn" class="block-btn" onclick="botGameBtnClick();">Play AWS Bot</button><br><br>
				<button id="create-lobby-btn" class="block-btn" onclick="createLobbyBtnClick();">Create Lobby</button><br><br>
				<button class="block-btn">Join Lobby</button><br><br>
			</div>

			<div id="game" style="display: none;" class="game-container">
				<input type="text" size="10" id="game-name" placeholder="Player Name">
				<input type="text" size="10" id="game-starting-roll" placeholder="Starting Roll">
				<button id="create-game" onclick="createGame();">Create Game</button> 
				<br>
				<br>
				<textarea rows="10" cols="45" id="game-log"></textarea> 
				<br>
				<br>
				<button id="roll-button" onclick="roll();" disabled>Roll</button><br><br>			
				<button id="home-btn"class="block-btn" onclick="homeBtnClick();">Home</button>
			</div>
			<div id="lobby" style="display: none;" class="game-container">
				<input type="text" size="10" id="create-lobby-name" placeholder="Player Name">
				<input type="text" size="10" id="create-lobby-starting-roll" placeholder="Starting Roll">
				<button id="create-lobby" onclick="createLobby();" >Create Lobby</button> 
			</div>
		</div>
	</body>
</html>

<script>
	var gameState;
	var lobby;
	var polling = false;
	var firstPoll = true;

	function createGame() {
		var game = {
						'players': [
							{
								'name': $('#game-name').val()
							},
							{
								'name': 'AWS Bot'
							}
						],
						'bet': $('#game-starting-roll').val()
					};
		
		$.ajax({
			type:'POST',
			url:'/game',
			data:JSON.stringify(game),
			contentType: 'application/json; charset=utf-8',
			dataType: 'json',
			success: function(data){updateGameStatus(data);},
    		error: function(errMsg) {alert('Something broke :(');}
		});
	}

	function getGame(gameId){
		$.ajax({
			async:false,
			type:'GET',
			url:'/game/' + gameId,
			contentType: 'application/json; charset=utf-8',
			dataType: 'json',
			success: function(data){updateGameStatus(data);},
    		error: function(errMsg) {alert('Something broke :(');}
		});
	}
	
	function pollGame(gameId){
		$.ajax({
			type:'GET',
			url:'/game/poll/' + gameId,
			contentType: 'application/json; charset=utf-8',
			dataType: 'json',
			success: function(data) {
								updateGameStatus(data);
								if( game.gameStatus !== 'FINISHED' ){
									pollGame(gameId);
								}

							},
    		error: function(errMsg) {alert('Something broke :(');}
		});
	}

	function createLobby(){
		var game = {
						'players': [
							{
								'name': $('#create-lobby-name').val()
							},
						],
						'bet': $('#create-lobby-starting-roll').val()
					};
		
		$.ajax({
			type:'POST',
			url:'/lobby',
			data:JSON.stringify(game),
			contentType: 'application/json; charset=utf-8',
			dataType: 'json',
			success: function(data){createLobbySuccess(data);},
    		error: function(errMsg) {alert('Something broke :(');}
		});

	
	}

	function createLobbySuccess(data){
		$('#game').show();
		$('#lobby').hide();
		$('#game-name').val($('#create-lobby-name').val());
		$('#game-starting-roll').val($('#create-lobby-starting-roll').val());
		$('#roll-button').attr('disabled', true);
		$('#create-game').html('Start Game');
		lobby = data;
		pollGame(lobby.gameId);
	}

	function roll (){
		$.ajax({
			type:'POST',
			url:'/game/roll',
			data:JSON.stringify(gameState),
			contentType: 'application/json; charset=utf-8',
			dataType: 'json',
			success: function(data){updateGameStatus(data);},
    		error: function(errMsg) {alert('Something broke :(');}
		});
	}

	function updateGameStatus (data){
		gameState = data;
		var gameLogInput = $('#game-log');
		gameLogInput.val(gameState.gameLogString);
		gameLogInput.scrollTop(gameLogInput[0].scrollHeight);
		$('#roll-button').html('Player ' + gameState.players[0].name + '\'s roll!');
		if(gameState.gameStatus === 'PLAYING') {
			$('#roll-button').removeAttr('disabled');
		} else {
			$('#roll-button').attr('disabled', true);
		}
	}

	function botGameBtnClick(){
		$('#game').show();
		$('#home-menu').hide();
	}
	function createLobbyBtnClick(){
		$('#lobby').show();
		$('#home-menu').hide();
	}
	function homeBtnClick(){
		$('#home-menu').show();		
		$('.game-container').hide();
	}


</script>