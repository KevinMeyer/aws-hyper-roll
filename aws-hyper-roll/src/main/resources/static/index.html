<!DOCTYPE html>
<html>
<head>
    <title>Death Roll</title>
    <link href="/webjars/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <script src="/webjars/jquery/jquery.min.js"></script>
    <script src="/webjars/sockjs-client/sockjs.min.js"></script>
    <script src="/webjars/stomp-websocket/stomp.min.js"></script>
    <script src="/app.js"></script>
</head>
	<body>
		<noscript>
			<h2 style="color: #ff0000">Seems your browser doesn't support Javascript! Websocket relies on Javascript being
				enabled. Please enable Javascript and reload this page!
			</h2>
		</noscript>
		<div id="app-container" style="padding-left: 10px;">
			<h3> AWS Death Roll MVP</h3>
			<div id="home-menu" style="display: block ;">
				<!-- <button id="bot-game-btn" class="block-btn" onclick="botGameBtnClick();">Play AWS Bot</button><br><br> -->
				<button id="create-lobby-btn" class="block-btn" onclick="createLobbyBtnClick();">Create Lobby</button><br><br>
				<button class="block-btn" onclick="joinLobbyBtnClick();">Join Lobby</button>
			</div>

			<div id="game" style="display: none;" class="game-container">
				Player Name:&nbsp<span id="player-game-name"></span>
				<!-- <input type="text" size="10" id="game-starting-roll" placeholder="Starting Roll"> -->
				<br>
				<textarea rows="10" cols="45" id="game-log" readonly></textarea> 
				<br>
				<br>
				<button id="roll-button" onclick="roll();">Roll</button><br>		
			</div>
			<div id="create-lobby" style="display: none;" class="game-container lobby">
				<input type="text" size="10" id="create-lobby-name" placeholder="Player Name">
				<input type="text" size="10" id="create-lobby-starting-roll" placeholder="Starting Roll">
				<button id="create-lobby" onclick="createLobby();">Create Lobby</button> 
			</div>
			<div id="join-lobby" style="display: none;" class="game-container lobby">
				<input type="text" size="10" id="join-lobby-name" placeholder="Player Name">
				<input type="text" size="4" id="join-lobby-code" placeholder="Code" onkeydown="return /[a-z]/i.test(event.key)">
				<button id="create-lobby" onclick="joinLobby();">Join Lobby</button> 
			</div>
			<br>
			<button id="home-btn"class="block-btn" onclick="homeBtnClick();">Home</button>
		</div>
	</body>
</html>

<script>
	var currentScreen = 'HOME';
	
	var gameState;
	var lobbyIds;

	var numberOfPolls = 0;
	

	// function createGame() {
	// 	var game = {
	// 					'player':{'name': $('#player-game-name').val()},
	// 					'initRoll': $('#game-starting-roll').val(),
	// 					'botGame': true
	// 				};
		
	// 	$.ajax({
	// 		type:'POST',
	// 		url:'/game',
	// 		data:JSON.stringify(game),
	// 		contentType: 'application/json; charset=utf-8',
	// 		dataType: 'json',
	// 		success: function(data){updateGameStatus(data);},
    // 		error: function(errMsg) {alert('Something broke :(');}
	// 	});
	// }
	// function getGame(gameId){
	// 	$.ajax({
	// 		async:false,
	// 		type:'GET',
	// 		url:'/game/' + gameId,
	// 		contentType: 'application/json; charset=utf-8',
	// 		dataType: 'json',
	// 		success: function(data){updateGameStatus(data);},
    // 		error: function(errMsg) {alert('Something broke :(');}
	// 	});
	// }
	

	function createLobby(){
		name = $('#create-lobby-name').val().trim();
		var lobby = {
						'player':{'name': name},
						'initRoll': $('#create-lobby-starting-roll').val(),
						'botGame': false
					};
		
		$.ajax({
			type:'POST',
			url:'/lobby',
			data:JSON.stringify(lobby),
			contentType: 'application/json; charset=utf-8',
			dataType: 'json',
			success: function(data){startLobby(data);},
    		error: function(errMsg) {alert('Something broke :(');}
		});

	
	}

	function joinLobby(){
		name = $('#join-lobby-name').val().trim();
		var player = {
			'name': name
		};
		$.ajax({
			type:'PATCH',
			url:'/lobby/join/' + $('#join-lobby-code').val(),
			data:JSON.stringify(player),
			contentType: 'application/json; charset=utf-8',
			dataType: 'json',
			success: function(data){startLobby(data);},
    		error: function(errMsg) {alert('Something broke :(');}
		});
	}
	function startLobby(data){
		currentScreen = 'GAME';
		$('#game').show();
		$('.lobby').hide();
		$('#player-game-name').html(name);
		lobbyIds = data;
		pollGame(lobbyIds.gameId, lobbyIds.playerId);
	}

	function pollGame(gameId, playerId){
		$.ajax({
			type:'GET',
			url:'/game/' + gameId + '/player/' + playerId,
			contentType: 'application/json; charset=utf-8',
			dataType: 'json',
			success: function(data) {
								updateGameStatus(data);
								if(numberOfPolls > 60 ) {
									alert('Game timed out after ten minutes!');
									console.log('Timed Out');
								} else if( gameState.gameStatus !== 'FINISHED' && currentScreen === 'GAME'){
									numberOfPolls++;
									pollGame(gameId, playerId);
								} else {
									console.log('Game finised or aborted');
								}

							},
    		error: function(errMsg) {alert('Something broke :(');}
		});
	}

	function roll (){
		$.ajax({
			type:'PATCH',
			url:'/game/roll/' + lobbyIds.gameId,
			contentType: 'application/json; charset=utf-8',
			dataType: 'json',
			success: function(data){updateGameStatus(data);},
    		error: function(errMsg) {alert('Something broke :(');}
		});
	}

	function updateGameStatus (data){
		gameState = data;
		var gameLogInput = $('#game-log');
		gameLogInput.val(gameState.gameLogString);
		gameLogInput.scrollTop(gameLogInput[0].scrollHeight);
		// Change button text
		if(gameState.gameStatus === 'FINISHED') {
			$('#roll-button').html('GAME OVER');
			$('#roll-button').attr('disabled', true);


		} else {
			$('#roll-button').html('Player ' + gameState.players[0].name + '\'s roll!');
			$('#roll-button').attr('disabled', lobbyIds.playerId !== gameState.players[0].playerId);
		}
	}

	function botGameBtnClick(){
		currentScreen = 'GAME';
		$('#game').show();
		$('#home-menu').hide();
	}
	function createLobbyBtnClick(){
		currentScreen = 'CREATE_LOBBY';
		$('#create-lobby').show();
		$('#home-menu').hide();
	}
	function joinLobbyBtnClick(){
		currentScreen = 'JOIN_LOBBY';
		$('#join-lobby').show();
		$('#home-menu').hide();
	}
	function homeBtnClick(){
		currentScreen = 'HOME';
		numberOfPolls = 0;
		$('#home-menu').show();		
		$('.game-container').hide();
	}
</script>